# 🔄 智能轮询功能说明

## 更新时间
2025-11-30 19:25

## 🎯 新增功能

### 1. **页面不存在处理** ⭐
当检索速度快于发帖速度时，页面可能尚不存在，现在会智能等待而不是报错。

### 2. **等待页面填满** ⭐
每页固定30条评论，不满30条说明还在继续添加中，会持续轮询直到满30条才切换到下一页。

## 📝 工作原理

### 页面不存在检测

**检测标志**:
```html
<h1>Page not found.</h1>
<div id="Message">The page you were looking for could not be found.</div>
```

**处理逻辑**:
```python
if 页面显示 "Page not found":
    ⏸️ 等待 CHECK_INTERVAL 秒
    🔄 重新检查当前页（不前进）
else:
    ✅ 正常处理评论
```

### 评论数量检查

**规则**:
- **满30条** → ✅ 切换到下一页
- **不满30条** → ⏳ 继续轮询当前页

**逻辑**:
```python
if 当前页评论数 >= 30:
    ✅ 页面已满，切换到 p{num+1}
else:
    ⏳ 页面未满，继续轮询 p{num}
```

## 🔍 使用场景

### 场景 1: 页面不存在
```
时间: 00:00 - 检查 p250
状态: Page not found
动作: ⏸️ 等待 60 秒

时间: 01:00 - 重新检查 p250
状态: Page not found
动作: ⏸️ 继续等待

时间: 02:00 - 再次检查 p250
状态: ✅ 页面存在，5 条评论
动作: 📭 未满 30 条，继续轮询
```

### 场景 2: 页面未满
```
时间: 00:00 - 检查 p245
状态: ✅ 存在，15 条评论
动作: ⏳ 未满 30 条，等待

时间: 01:00 - 检查 p245
状态: ✅ 存在，23 条评论
动作: ⏳ 仍未满，继续等待

时间: 02:00 - 检查 p245
状态: ✅ 存在，30 条评论
动作: ✅ 已满，切换到 p246
```

### 场景 3: 正常流程
```
时间: 00:00 - 检查 p245
状态: ✅ 存在，30 条评论
动作: ✅ 已满，切换到 p246

时间: 01:00 - 检查 p246
状态: ✅ 存在，30 条评论
动作: ✅ 已满，切换到 p247
```

## 📊 日志示例

### 页面不存在
```
🔍 检查页面 250
⚠️  页面 250 尚不存在，等待中...
⏸️  页面 250 尚不存在，等待 60 秒后重新检查...
# 等待 60 秒
🔍 检查页面 250  # 重新检查
```

### 页面未满
```
🔍 检查页面 245
📊 找到 15 条评论
📭 页面 245 没有 FAT32 的符合条件的评论
⏳ 页面 245 仅有 15 条评论（未满30条），等待 60 秒后继续检查...
# 等待 60 秒
🔍 检查页面 245  # 继续检查同一页
```

### 页面已满（切换）
```
🔍 检查页面 245
📊 找到 30 条评论
🎯 发现 FAT32 的评论: Comment_4629336
✅ 页面 245 已满 (30 条评论)，切换到下一页
⏳ 等待 60 秒后检查下一页...
🔍 检查页面 246  # 新页面
```

## ⚙️ 配置参数

使用现有的 `CHECK_INTERVAL` 控制轮询间隔：

```bash
# .env
CHECK_INTERVAL=60  # 轮询间隔（秒）

# 建议值：
# - 快速监控: 30 秒
# - 正常监控: 60 秒  ⭐ 推荐
# - 节省资源: 120 秒
```

## 💡 设计原因

### 为什么要等待页面满30条？

1. **避免重复检查**
   - 每页固定30条评论
   - 未满说明还在添加中
   - 等待满了再切换，避免遗漏

2. **减少无效请求**
   - 未满的页面会持续更新
   - 过早切换会错过新评论
   - 等待满了确保完整性

3. **提高效率**
   - 一次性处理完整页面
   - 减少往返切换
   - 更好的资源利用

### 为什么要处理页面不存在？

1. **监控速度可能超前**
   - 检查速度 > 发帖速度
   - 提前到达未创建的页面
   - 需要等待而不是报错

2. **保持连续性**
   - 不会因为页面不存在而中断
   - 自动等待并重试
   - 确保不遗漏任何评论

## 🔄 完整流程

```
开始监控 p{num}
    ↓
加载页面
    ↓
检查是否 "Page not found"?
    ├─ 是 → 等待后重新检查（不前进）
    └─ 否 → 继续
    ↓
解析评论
    ↓
发现目标用户评论？
    ├─ 是 → 发送通知
    └─ 否 → 记录
    ↓
评论数 >= 30?
    ├─ 是 → num++，切换到下一页
    └─ 否 → 继续检查当前页
    ↓
等待 CHECK_INTERVAL 秒
    ↓
返回"加载页面"
```

## 📈 效果对比

| 功能 | 修改前 | 修改后 |
|------|--------|--------|
| 页面不存在 | ❌ 报错退出 | ✅ 等待轮询 |
| 页面未满 | ❌ 直接切换（可能遗漏） | ✅ 等待满30条 |
| 监控连续性 | ❌ 遇404会中断 | ✅ 自动恢复 |
| 评论完整性 | ⚠️ 可能遗漏 | ✅ 100%完整 |

## 🧪 测试场景

### 测试 1: 页面不存在
```bash
# 从一个不存在的页面开始
python monitor.py --start-page 999

# 预期：等待而不是报错
```

### 测试 2: 页面未满
```bash
# 从当前正在添加的页面开始
python monitor.py --start-page 245

# 预期：持续检查直到满30条
```

## ⚠️ 注意事项

1. **轮询间隔不要太短**
   - 建议至少 60 秒
   - 避免频繁请求被限制

2. **页面不存在会持续等待**
   - 如果真的没有这个页面，会一直等待
   - 可以手动停止或调整起始页面

3. **评论数量基准**
   - 论坛标准：每页 30 条评论
   - 如果论坛改变标准，需要修改代码

## 🎯 最佳实践

### 推荐配置
```bash
CHECK_INTERVAL=60  # 60秒轮询间隔
START_PAGE=245     # 从当前页面开始
```

### 监控策略

**追赶模式**（从旧页面开始）:
- 页面都已满30条
- 快速切换到最新页面

**实时模式**（从最新页面开始）:
- 可能遇到未满或不存在的页面
- 自动等待和轮询

## ✅ 改进总结

- ✅ **智能等待**: 页面不存在时自动轮询
- ✅ **完整性保证**: 等待页面满30条
- ✅ **无缝监控**: 不会因为404中断
- ✅ **资源优化**: 避免无效的页面切换

---

**更新状态**: ✅ 已完成
**建议**: 使用 60 秒轮询间隔，从当前页面开始监控
